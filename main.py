import streamlit as st
import random
from datetime import datetime, timedelta

# ------------------------ åŸºç¡€æ•°æ®é…ç½® ------------------------
zodiacs = ["é¼ ", "ç‰›", "è™", "å…”", "é¾™", "è›‡", "é©¬", "ç¾Š", "çŒ´", "é¸¡", "ç‹—", "çŒª"]
tiangans = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"]
dizhis = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"]

nayin_map = {
    ("ç”²å­", "ä¹™ä¸‘"): ("æµ·ä¸­é‡‘", "é‡‘"), ("ä¸™å¯…", "ä¸å¯"): ("ç‚‰ä¸­ç«", "ç«"),
    ("æˆŠè¾°", "å·±å·³"): ("å¤§æ—æœ¨", "æœ¨"), ("åºšåˆ", "è¾›æœª"): ("è·¯æ—åœŸ", "åœŸ"),
    ("å£¬ç”³", "ç™¸é…‰"): ("å‰‘é”‹é‡‘", "é‡‘"), ("ç”²æˆŒ", "ä¹™äº¥"): ("å±±å¤´ç«", "ç«"),
    ("ä¸™å­", "ä¸ä¸‘"): ("æ¶§ä¸‹æ°´", "æ°´"), ("æˆŠå¯…", "å·±å¯"): ("åŸå¤´åœŸ", "åœŸ"),
    ("åºšè¾°", "è¾›å·³"): ("ç™½èœ¡é‡‘", "é‡‘"), ("å£¬åˆ", "ç™¸æœª"): ("æ¨æŸ³æœ¨", "æœ¨"),
    ("ç”²ç”³", "ä¹™é…‰"): ("æ³‰ä¸­æ°´", "æ°´"), ("ä¸™æˆŒ", "ä¸äº¥"): ("å±‹ä¸ŠåœŸ", "åœŸ"),
    ("æˆŠå­", "å·±ä¸‘"): ("éœ¹é›³ç«", "ç«"), ("åºšå¯…", "è¾›å¯"): ("æ¾æŸæœ¨", "æœ¨"),
    ("å£¬è¾°", "ç™¸å·³"): ("é•¿æµæ°´", "æ°´"), ("ç”²åˆ", "ä¹™æœª"): ("æ²™ä¸­é‡‘", "é‡‘"),
    ("ä¸™ç”³", "ä¸é…‰"): ("å±±ä¸‹ç«", "ç«"), ("æˆŠæˆŒ", "å·±äº¥"): ("å¹³åœ°æœ¨", "æœ¨"),
    ("åºšå­", "è¾›ä¸‘"): ("å£ä¸ŠåœŸ", "åœŸ"), ("å£¬å¯…", "ç™¸å¯"): ("é‡‘ç®”é‡‘", "é‡‘"),
    ("ç”²è¾°", "ä¹™å·³"): ("è¦†ç¯ç«", "ç«"), ("ä¸™åˆ", "ä¸æœª"): ("å¤©æ²³æ°´", "æ°´"),
    ("æˆŠç”³", "å·±é…‰"): ("å¤§é©¿åœŸ", "åœŸ"), ("åºšæˆŒ", "è¾›äº¥"): ("é’—é’é‡‘", "é‡‘"),
    ("å£¬å­", "ç™¸ä¸‘"): ("æ¡‘æŸ˜æœ¨", "æœ¨"), ("ç”²å¯…", "ä¹™å¯"): ("å¤§æºªæ°´", "æ°´"),
    ("ä¸™è¾°", "ä¸å·³"): ("æ²™ä¸­åœŸ", "åœŸ"), ("æˆŠåˆ", "å·±æœª"): ("å¤©ä¸Šç«", "ç«"),
    ("åºšç”³", "è¾›é…‰"): ("çŸ³æ¦´æœ¨", "æœ¨"), ("å£¬æˆŒ", "ç™¸äº¥"): ("å¤§æµ·æ°´", "æ°´")
}

rel_config = {
    "å…­åˆ": [("é¼ ", "ç‰›"), ("è™", "çŒª"), ("å…”", "ç‹—"), ("é¾™", "é¸¡"), ("è›‡", "çŒ´"), ("é©¬", "ç¾Š")],
    "å…­å†²": [("é¼ ", "é©¬"), ("ç‰›", "ç¾Š"), ("è™", "çŒ´"), ("å…”", "é¸¡"), ("é¾™", "ç‹—"), ("è›‡", "çŒª")],
    "å…­å®³": [("é¼ ", "ç¾Š"), ("ç‰›", "é©¬"), ("è™", "è›‡"), ("å…”", "é¾™"), ("ç‹—", "é¸¡"), ("çŒ´", "çŒª")],
    "ä¸‰åˆ": [["çŒ´", "é¼ ", "é¾™"], ["è™", "é©¬", "ç‹—"], ["è›‡", "é¸¡", "ç‰›"], ["çŒª", "å…”", "ç¾Š"]]
}

# ------------------------ ä¿®æ­£åçš„æ ¸å¿ƒç®—æ³• ------------------------
def get_zodiac(year):
    """è·å–ç”Ÿè‚–ï¼ˆç«‹æ˜¥å‰ç®—å‰ä¸€å¹´ï¼‰"""
    # ç®€åŒ–ä¸ºå…¬å†2æœˆ4æ—¥å‰ååˆ†ç•Œ
    return zodiacs[(year - 4) % 12]

def get_ganzhi(year):
    """æ­£ç¡®è®¡ç®—å¹´æŸ±"""
    gan_index = (year - 4) % 10
    zhi_index = (year - 4) % 12
    return tiangans[gan_index] + dizhis[zhi_index]

def get_month_gan(y_gan, month):
    """æ­£ç¡®æœˆå¹²è®¡ç®—ï¼ˆå¹´ä¸Šèµ·æœˆæ³•ï¼‰"""
    start_map = {0:2, 1:4, 2:6, 3:8, 4:0, 5:2, 6:4, 7:6, 8:8, 9:0}  # ç”²å¹´ä»ä¸™å¼€å§‹
    return tiangans[(start_map[y_gan] + month - 1) % 10]

def get_hour_gan(d_gan, hour_zhi_index):
    """æ­£ç¡®æ—¶å¹²è®¡ç®—ï¼ˆæ—¥ä¸Šèµ·æ—¶æ³•ï¼‰"""
    start_map = {0:0, 1:1, 2:3, 3:5, 4:7, 5:0, 6:1, 7:3, 8:5, 9:7}  # ç”²æ—¥ä»ç”²å¼€å§‹
    return tiangans[(start_map[d_gan] + hour_zhi_index) % 10]

def get_sizhu(birth_time):
    """ä¿®æ­£åçš„å››æŸ±æ’ç›˜"""
    year = birth_time.year
    month = birth_time.month
    day = birth_time.day
    hour = birth_time.hour
    
    # å¹´æŸ±
    year_gan = tiangans[(year - 4) % 10]
    year_zhi = dizhis[(year - 4) % 12]
    
    # æœˆæŸ±
    y_gan_index = (year - 4) % 10
    month_zhi_index = (month + 1) % 12  # æ­£æœˆ=å¯…
    month_gan = get_month_gan(y_gan_index, month)
    month_zhi = dizhis[month_zhi_index]
    
    # æ—¥æŸ±ï¼ˆç¤ºä¾‹æ•°æ®ï¼Œå®é™…éœ€ä¸‡å¹´å†æ¥å£ï¼‰
    day_gan = tiangans[(day * 5 + 3) % 10]  # æ¨¡æ‹Ÿç®—æ³•
    day_zhi = dizhis[(day * 3 + 1) % 12]
    
    # æ—¶æŸ±
    hour_zhi_index = (hour + 1) // 2 % 12
    d_gan_index = (day * 5 + 3) % 10  # ä¸æ—¥å¹²åŒæ­¥
    hour_gan = get_hour_gan(d_gan_index, hour_zhi_index)
    hour_zhi = dizhis[hour_zhi_index]
    
    return {
        "å¹´æŸ±": f"{year_gan}{year_zhi}",
        "æœˆæŸ±": f"{month_gan}{month_zhi}",
        "æ—¥æŸ±": f"{day_gan}{day_zhi}",
        "æ—¶æŸ±": f"{hour_gan}{hour_zhi}"
    }

def recommend_date(zodiac):
    """å©šæœŸæ¨èç®—æ³•"""
    sanhe_map = {
        "é¼ ": [2024, 2028, 2032], "çŒ´": [2024, 2028, 2032],
        "é¾™": [2024, 2028, 2032], "è™": [2026, 2030, 2034],
        "é©¬": [2026, 2030, 2034], "ç‹—": [2026, 2030, 2034],
        "è›‡": [2025, 2029, 2033], "é¸¡": [2025, 2029, 2033],
        "ç‰›": [2025, 2029, 2033], "çŒª": [2027, 2031, 2035],
        "å…”": [2027, 2031, 2035], "ç¾Š": [2027, 2031, 2035]
    }
    current_year = datetime.now().year
    years = [y for y in sanhe_map[zodiac] if y >= current_year][:3]
    return f"{min(years)}-{max(years)}å¹´ä¸‰åˆå¹´ä»½"

def child_prediction(wx_rel):
    """å­å—£é¢„æµ‹ç®—æ³•"""
    if wx_rel[0] == "ç›¸ç”Ÿ":
        return "å­å¥³è¿æ—ºç››ï¼Œæ˜“å¾—è´µå­ï¼ˆäº”è¡Œç›¸ç”Ÿï¼Œæ°”è¡€é€šç•…ï¼‰"
    elif wx_rel[0] == "ç›¸å…‹":
        return "éœ€æ³¨æ„å­å¥³å¥åº·ï¼Œå»ºè®®å­•æœŸè°ƒç†ï¼ˆäº”è¡Œåˆ¶åŒ–ï¼Œå¹³è¡¡ä¸ºè¦ï¼‰"
    return "å­å¥³ç¼˜å¹³å’Œï¼Œæ•™å…»ä¸ºé‡ï¼ˆäº”è¡Œä¸­å’Œï¼Œåå¤©ä¸ºè¦ï¼‰"

# ------------------------ ç•Œé¢æ¨¡å—ï¼ˆä¿æŒä¸å˜ï¼‰ ------------------------
# [åŸdisplay_analysisã€classic_commentã€modern_commentç­‰å‡½æ•°ä¿æŒä¸å˜]

# ------------------------ ä¸»ç¨‹åº ------------------------
def main():
    st.set_page_config("å‘¨æ˜“å©šé…ç³»ç»Ÿ", layout="wide")
    st.title("ğŸ å…«å­—å©šé…åˆ†æç³»ç»Ÿï¼ˆä¿®æ­£ç‰ˆï¼‰")
    
    if st.button("ğŸ² ç”Ÿæˆéšæœºæµ‹è¯•æ•°æ®ï¼ˆ5å¯¹ï¼‰"):
        for _ in range(5):
            man_date = datetime(1990,1,1) + timedelta(days=random.randint(0, 10950))
            woman_date = datetime(1990,1,1) + timedelta(days=random.randint(0, 10950))
            
            man = {
                "ç”Ÿè‚–": get_zodiac(man_date.year),
                "å››æŸ±": get_sizhu(man_date),
                "çº³éŸ³": get_nayin(get_ganzhi(man_date.year)),
                "äº”è¡Œ": get_nayin(get_ganzhi(man_date.year))[1]
            }
            woman = {
                "ç”Ÿè‚–": get_zodiac(woman_date.year),
                "å››æŸ±": get_sizhu(woman_date),
                "çº³éŸ³": get_nayin(get_ganzhi(woman_date.year)),
                "äº”è¡Œ": get_nayin(get_ganzhi(woman_date.year))[1]
            }
            
            display_analysis(man, woman)
            st.divider()

if __name__ == "__main__":
    main()
